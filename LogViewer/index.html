<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loki Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .control-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }

        .control-group input,
        .control-group select {
            padding: 10px;
            border: 2px solid #e1e5e9;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            height: fit-content;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .logs-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .logs-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logs-count {
            font-weight: 600;
            color: #555;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .logs-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 15px 20px;
            border-bottom: 1px solid #f1f3f4;
            transition: background-color 0.2s;
        }

        .log-entry:hover {
            background-color: #f8f9fa;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .log-level {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .log-level.trace { background: #e3f2fd; color: #1976d2; }
        .log-level.debug { background: #f3e5f5; color: #7b1fa2; }
        .log-level.info { background: #e8f5e8; color: #388e3c; }
        .log-level.warn { background: #fff3e0; color: #f57c00; }
        .log-level.error { background: #ffebee; color: #d32f2f; }
        .log-level.critical { background: #fce4ec; color: #c2185b; }

        .log-timestamp {
            color: #666;
            font-size: 12px;
        }

        .log-message {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-source {
            color: #888;
            font-size: 12px;
            margin-top: 5px;
        }

        .log-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .log-label {
            background: #f0f0f0;
            color: #555;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
        }

        .log-label.key {
            background: #e3f2fd;
            color: #1976d2;
        }

        .log-label.value {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .no-logs {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        @media (max-width: 768px) {
            .control-row {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                min-width: auto;
            }

            .log-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Loki Log Viewer</h1>
            <p>Real-time log monitoring with advanced filtering and pagination</p>
        </div>

        <div class="controls">
            <div class="control-row">
                <div class="control-group">
                    <label for="levelFilter">Log Level</label>
                    <select id="levelFilter">
                        <option value="">All Levels</option>
                        <option value="trace">Trace</option>
                        <option value="debug">Debug</option>
                        <option value="info">Info</option>
                        <option value="warn">Warning</option>
                        <option value="error">Error</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="searchFilter">Search Message</label>
                    <input type="text" id="searchFilter" placeholder="Search in log messages...">
                </div>
                <div class="control-group">
                    <label for="timeRange">Time Range</label>
                    <select id="timeRange">
                        <option value="1h">Last Hour</option>
                        <option value="6h">Last 6 Hours</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="pageSize">Page Size</label>
                    <select id="pageSize">
                        <option value="10">10 logs</option>
                        <option value="25" selected>25 logs</option>
                        <option value="50">50 logs</option>
                        <option value="100">100 logs</option>
                    </select>
                </div>
            </div>
            <div class="control-row">
                <button class="btn" onclick="loadLogs()">üîç Filter Logs</button>
                <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Clear Filters</button>
                <button class="btn btn-secondary" onclick="generateTestLogs()">üß™ Generate Test Logs</button>
            </div>
        </div>

        <div class="logs-container">
            <div class="logs-header">
                <div class="logs-count" id="logsCount">Loading logs...</div>
                <button class="refresh-btn" onclick="loadLogs()">üîÑ Refresh</button>
            </div>
            <div class="logs-list" id="logsList">
                <div class="loading">Loading logs...</div>
            </div>
            <div class="pagination" id="pagination" style="display: none;">
                <button onclick="changePage(-1)">‚Üê Previous</button>
                <span id="pageInfo">Page 1 of 1</span>
                <button onclick="changePage(1)">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let isLoading = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadLogs();
            
            // Add event listeners for real-time filtering
            document.getElementById('levelFilter').addEventListener('change', loadLogs);
            document.getElementById('searchFilter').addEventListener('input', debounce(loadLogs, 500));
            document.getElementById('timeRange').addEventListener('change', loadLogs);
            document.getElementById('pageSize').addEventListener('change', function() {
                currentPage = 1;
                loadLogs();
            });
        });

        // Debounce function to limit API calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Load logs from Loki API
        async function loadLogs() {
            if (isLoading) return;
            
            isLoading = true;
            const logsList = document.getElementById('logsList');
            const logsCount = document.getElementById('logsCount');
            const pagination = document.getElementById('pagination');
            
            try {
                logsList.innerHTML = '<div class="loading">Loading logs...</div>';
                logsCount.textContent = 'Loading logs...';
                pagination.style.display = 'none';

                const params = new URLSearchParams({
                    query: buildQuery(),
                    limit: document.getElementById('pageSize').value,
                    start: getTimeRangeStart(),
                    end: Math.floor(Date.now() * 1000000).toString(),
                    direction: 'backward'
                });

                // Read directly from Loki API
                let logs = [];
                try {
                    const response = await fetch(`/api/loki/loki/api/v1/query_range?${params}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    logs = parseLokiResponse(data);
                    
                    if (logs.length === 0) {
                        // If no logs from Loki, generate some test logs and send them to Loki
                        console.log('No logs found in Loki, generating test logs...');
                        await generateAndSendTestLogs();
                        
                        // Wait a moment for logs to be processed
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Retry the query
                        const retryResponse = await fetch(`/api/loki/loki/api/v1/query_range?${params}`);
                        if (retryResponse.ok) {
                            const retryData = await retryResponse.json();
                            logs = parseLokiResponse(retryData);
                        }
                        
                        // If still no logs, show a message
                        if (logs.length === 0) {
                            logs = [{
                                timestamp: new Date().toISOString(),
                                level: 'info',
                                message: 'No logs found in Loki. Click "Generate Test Logs" to create some logs.',
                                source: 'LogViewer',
                                raw: 'No logs available'
                            }];
                        }
                    }
                } catch (lokiError) {
                    console.error('Error reading from Loki:', lokiError);
                    // Show error message instead of throwing
                    logs = [{
                        timestamp: new Date().toISOString(),
                        level: 'error',
                        message: 'Failed to connect to Loki: ' + lokiError.message + '. Please check if Loki service is running.',
                        source: 'LogViewer',
                        raw: 'Loki connection error'
                    }];
                }
                
                displayLogs(logs);
                updatePagination(logs.length);
                logsCount.textContent = `Showing ${logs.length} logs`;
                
            } catch (error) {
                console.error('Error loading logs:', error);
                logsList.innerHTML = '<div class="error">Error loading logs: ' + error.message + '<br>Please check if the API is running and try again.</div>';
                logsCount.textContent = 'Error loading logs';
            } finally {
                isLoading = false;
            }
        }

        // Build query string for Loki
        function buildQuery() {
            let query = '{job="lokitest-api"}';
            
            const level = document.getElementById('levelFilter').value;
            if (level) {
                query += ` |~ "(?i)${level}"`;
            }
            
            const search = document.getElementById('searchFilter').value.trim();
            if (search) {
                query += ` |~ "(?i)${search}"`;
            }
            
            return query;
        }

        // Get time range start timestamp
        function getTimeRangeStart() {
            const timeRange = document.getElementById('timeRange').value;
            const now = new Date();
            let startTime;
            
            switch (timeRange) {
                case '1h':
                    startTime = new Date(now.getTime() - 60 * 60 * 1000);
                    break;
                case '6h':
                    startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000);
                    break;
                case '24h':
                    startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    break;
                default:
                    startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            }
            
            // Convert to nanoseconds for Loki
            return Math.floor(startTime.getTime() * 1000000).toString();
        }

        // Parse Loki API response
        function parseLokiResponse(data) {
            if (!data.data || !data.data.result) {
                return [];
            }
            
            const logs = [];
            data.data.result.forEach(stream => {
                if (stream.values) {
                    // Extract stream labels (job, level, source, etc.)
                    const streamLabels = stream.stream || {};
                    
                    stream.values.forEach(([timestamp, message]) => {
                        try {
                            // Parse the log message (assuming JSON format from Serilog)
                            const logData = JSON.parse(message);
                            logs.push({
                                timestamp: new Date(parseInt(timestamp) / 1000000).toISOString(),
                                level: streamLabels.level || logData['@l'] || logData['Level'] || 'info',
                                message: logData['@mt'] || logData['@m'] || logData['Message'] || message,
                                source: streamLabels.source || logData['SourceContext'] || logData['Source'] || 'Unknown',
                                job: streamLabels.job || 'unknown',
                                labels: streamLabels,
                                raw: message
                            });
                        } catch (e) {
                            // If not JSON, try to extract level from plain text
                            const levelMatch = message.match(/\[(TRACE|DEBUG|INFO|WARN|ERROR|CRITICAL|FATAL)\]/i);
                            const sourceMatch = message.match(/\[([^\]]+Controller|[^\]]+Service)\]/);
                            
                            logs.push({
                                timestamp: new Date(parseInt(timestamp) / 1000000).toISOString(),
                                level: streamLabels.level || (levelMatch ? levelMatch[1].toLowerCase() : 'info'),
                                message: message.replace(/\[(TRACE|DEBUG|INFO|WARN|ERROR|CRITICAL|FATAL)\]/gi, '').trim(),
                                source: streamLabels.source || (sourceMatch ? sourceMatch[1] : 'Unknown'),
                                job: streamLabels.job || 'unknown',
                                labels: streamLabels,
                                raw: message
                            });
                        }
                    });
                }
            });
            
            return logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }


        // Display logs in the UI
        function displayLogs(logs) {
            const logsList = document.getElementById('logsList');
            
            if (logs.length === 0) {
                logsList.innerHTML = '<div class="no-logs">No logs found matching your criteria</div>';
                return;
            }
            
            logsList.innerHTML = logs.map(log => {
                // Create labels display
                const labelsHtml = Object.entries(log.labels || {})
                    .filter(([key, value]) => key && value && key !== 'level') // Exclude level as it's shown separately
                    .map(([key, value]) => `
                        <span class="log-label key">${escapeHtml(key)}</span>
                        <span class="log-label value">${escapeHtml(value)}</span>
                    `).join('');
                
                // Clean source text to avoid duplicate "Source:" labels
                const sourceText = log.source.replace(/^Source:\s*/i, '');
                
                return `
                    <div class="log-entry">
                        <div class="log-header">
                            <span class="log-level ${log.level}">${log.level}</span>
                            <span class="log-timestamp">${formatTimestamp(log.timestamp)}</span>
                        </div>
                        <div class="log-message">${escapeHtml(log.message)}</div>
                        <div class="log-source">Source: ${escapeHtml(sourceText)}</div>
                        ${labelsHtml ? `<div class="log-labels">${labelsHtml}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update pagination controls
        function updatePagination(totalCount) {
            const pageSize = parseInt(document.getElementById('pageSize').value);
            totalPages = Math.ceil(totalCount / pageSize);
            
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            } else {
                pagination.style.display = 'none';
            }
        }

        // Change page
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                loadLogs();
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('levelFilter').value = '';
            document.getElementById('searchFilter').value = '';
            document.getElementById('timeRange').value = '24h';
            currentPage = 1;
            loadLogs();
        }

        // Generate test logs by calling the API
        async function generateTestLogs() {
            try {
                const response = await fetch('/api/test/WeatherForecast/test-logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Test logs generated successfully! ${result.count} logs created.`);
                    loadLogs(); // Refresh the log view
                } else {
                    throw new Error('Failed to generate test logs');
                }
            } catch (error) {
                console.error('Error generating test logs:', error);
                alert('Error generating test logs: ' + error.message + '. Please check if the API service is running.');
            }
        }

        // Generate and send test logs to Loki
        async function generateAndSendTestLogs() {
            try {
                // First, generate logs via API
                const response = await fetch('/api/test/WeatherForecast/test-logs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    console.log('Test logs generated via API');
                }
                
                // Also send some test logs directly to Loki
                const timestamp = Date.now() * 1000000; // Convert to nanoseconds
                const testLogs = [
                    {
                        stream: { 
                            job: "lokitest-api", 
                            level: "info", 
                            source: "WeatherForecastController",
                            component: "api",
                            environment: "development"
                        },
                        values: [[timestamp.toString(), "Weather forecast requested"]]
                    },
                    {
                        stream: { 
                            job: "lokitest-api", 
                            level: "info", 
                            source: "WeatherForecastController",
                            component: "api",
                            environment: "development"
                        },
                        values: [[(timestamp + 1000000).toString(), "Generated 5 weather forecasts"]]
                    },
                    {
                        stream: { 
                            job: "lokitest-api", 
                            level: "error", 
                            source: "WeatherForecastController",
                            component: "api",
                            environment: "development",
                            error_code: "E001"
                        },
                        values: [[(timestamp + 2000000).toString(), "Error processing item 3: Simulated error"]]
                    },
                    {
                        stream: { 
                            job: "lokitest-api", 
                            level: "warn", 
                            source: "DatabaseService",
                            component: "database",
                            environment: "development"
                        },
                        values: [[(timestamp + 3000000).toString(), "Database connection timeout"]]
                    },
                    {
                        stream: { 
                            job: "lokitest-api", 
                            level: "debug", 
                            source: "CacheService",
                            component: "cache",
                            environment: "development"
                        },
                        values: [[(timestamp + 4000000).toString(), "Cache miss for key: user:123"]]
                    }
                ];
                
                const lokiResponse = await fetch('/api/loki/loki/api/v1/push', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ streams: testLogs })
                });
                
                if (lokiResponse.ok) {
                    console.log('Test logs sent directly to Loki');
                } else {
                    console.warn('Failed to send test logs to Loki:', lokiResponse.statusText);
                }
            } catch (error) {
                console.warn('Error sending test logs to Loki:', error);
            }
        }

        // Utility functions
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Auto-refresh every 30 seconds
        setInterval(loadLogs, 30000);
    </script>
</body>
</html>
